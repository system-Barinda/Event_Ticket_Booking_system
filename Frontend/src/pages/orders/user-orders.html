<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>All Events</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-8">

  <div class="max-w-7xl mx-auto">

    <h2 class="text-3xl font-semibold text-gray-800 mb-6">
      All Events
    </h2>

    <!-- Controls -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">

      <div class="flex flex-col md:flex-row gap-4 w-full">

        <input 
          type="text"
          id="searchInput"
          placeholder="Search events..."
          class="w-full md:w-1/3 px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >

        <select 
          id="statusFilter"
          class="w-full md:w-1/4 px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="all">All Status</option>
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
          <option value="rejected">Rejected</option>
        </select>

        <select 
          id="sortOrder"
          class="w-full md:w-1/4 px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>

        <select 
          id="itemsPerPageSelect"
          class="w-full md:w-1/5 px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="6">6 per page</option>
          <option value="9">9 per page</option>
          <option value="12">12 per page</option>
        </select>

      </div>
    </div>

    <!-- Results Info -->
    <div id="resultsInfo" class="text-sm text-gray-600 mb-4"></div>

    <!-- Events -->
    <div id="orders-container"></div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-2 mt-8"></div>

  </div>

<script>

let allEvents = [];
let filteredEvents = [];
let currentPage = 1;
let itemsPerPage = 6;

document.addEventListener("DOMContentLoaded", function () {
  loadEvents();

  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("statusFilter").addEventListener("change", applyFilters);
  document.getElementById("sortOrder").addEventListener("change", applyFilters);
  document.getElementById("itemsPerPageSelect").addEventListener("change", function() {
    itemsPerPage = parseInt(this.value);
    currentPage = 1;
    renderPage();
  });
});

async function loadEvents() {
  const container = document.getElementById("orders-container");

  container.innerHTML = `
    <div class="flex justify-center items-center py-16">
      <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
    </div>
  `;

  try {
    const response = await fetch(
      "http://localhost/Event_Ticket_Booking_system/backend/modules/events/get-all-events.php"
    );

    const data = await response.json();

    if (!data.success || !data.events) {
      container.innerHTML = `<p class="text-gray-500 text-center">No events available.</p>`;
      return;
    }

    allEvents = data.events;
    applyFilters();

  } catch (error) {
    container.innerHTML = `<p class="text-red-500 text-center">Connection Failed</p>`;
  }
}

function applyFilters() {

  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const selectedStatus = document.getElementById("statusFilter").value;
  const sortOrder = document.getElementById("sortOrder").value;

  filteredEvents = allEvents.filter(event => {

    const matchesSearch =
      (event.title && event.title.toLowerCase().includes(searchValue)) ||
      (event.description && event.description.toLowerCase().includes(searchValue)) ||
      (event.category && event.category.toLowerCase().includes(searchValue)) ||
      (event.city && event.city.toLowerCase().includes(searchValue)) ||
      (event.language && event.language.toLowerCase().includes(searchValue));

    const matchesStatus =
      selectedStatus === "all" || event.status === selectedStatus;

    return matchesSearch && matchesStatus;
  });

  filteredEvents.sort((a, b) => {
    const dateA = new Date(a.created_at);
    const dateB = new Date(b.created_at);
    return sortOrder === "newest" ? dateB - dateA : dateA - dateB;
  });

  currentPage = 1;
  renderPage();
}

function renderPage() {

  const totalItems = filteredEvents.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);

  const start = (currentPage - 1) * itemsPerPage;
  const end = Math.min(start + itemsPerPage, totalItems);

  const paginatedItems = filteredEvents.slice(start, end);

  updateResultsInfo(start, end, totalItems);
  displayEvents(paginatedItems);
  renderPagination(totalPages);
}

function updateResultsInfo(start, end, total) {
  const info = document.getElementById("resultsInfo");

  if (total === 0) {
    info.innerHTML = "";
    return;
  }

  info.innerHTML = `Showing <strong>${start + 1}</strong>â€“<strong>${end}</strong> of <strong>${total}</strong> results`;
}

function displayEvents(events) {

  const container = document.getElementById("orders-container");

  if (events.length === 0) {
    container.innerHTML = `<p class="text-gray-500 text-center py-10">No matching events found.</p>`;
    return;
  }

  container.innerHTML = `<div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
  const grid = container.querySelector("div");

  events.forEach(event => {

    let badgeColor = "bg-yellow-100 text-yellow-700";
    if (event.status === "approved") badgeColor = "bg-green-100 text-green-700";
    if (event.status === "rejected") badgeColor = "bg-red-100 text-red-700";

    const card = document.createElement("div");
    card.className = "bg-white rounded-2xl shadow-sm hover:shadow-lg transition duration-300 overflow-hidden";

    card.innerHTML = `
      ${event.event_image ? `
        <img 
          src="http://localhost/Event_Ticket_Booking_system/backend/uploads/${event.event_image}" 
          class="w-full h-48 object-cover"
          onerror="this.style.display='none'"
        >
      ` : ""}

      <div class="p-6 space-y-3">
        <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${badgeColor}">
          ${event.status}
        </span>

        <h3 class="text-lg font-semibold text-gray-800">
          ${event.title}
        </h3>

        <p class="text-sm text-gray-500 line-clamp-3">
          ${event.description ?? "No description provided."}
        </p>

        <div class="text-sm text-gray-600 space-y-1">
          <p><strong>Category:</strong> ${event.category ?? "N/A"}</p>
          <p><strong>City:</strong> ${event.city ?? "N/A"}</p>
          <p><strong>Language:</strong> ${event.language ?? "N/A"}</p>
        </div>

        <p class="text-xs text-gray-400 pt-2 border-t">
          Created: ${event.created_at}
        </p>
      </div>
    `;

    grid.appendChild(card);
  });
}

function renderPagination(totalPages) {

  const pagination = document.getElementById("pagination");

  if (totalPages <= 1) {
    pagination.innerHTML = "";
    return;
  }

  pagination.innerHTML = `
    <button onclick="changePage(-1)" 
      class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-200"
      ${currentPage === 1 ? "disabled class='opacity-50 cursor-not-allowed'" : ""}>
      Previous
    </button>

    <span class="px-4 text-sm text-gray-600">
      Page ${currentPage} of ${totalPages}
    </span>

    <button onclick="changePage(1)" 
      class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-200"
      ${currentPage === totalPages ? "disabled class='opacity-50 cursor-not-allowed'" : ""}>
      Next
    </button>
  `;
}

function changePage(direction) {
  currentPage += direction;
  renderPage();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

</script>

</body>
</html>